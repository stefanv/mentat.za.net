<!DOCTYPE html>
<html lang="en-us">
    <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Where we set up a firewall that allows traffic to leave only via the VPN.">

  <title>VPN-only access to the internet &middot; Stéfan&#39;s blog</title>

  
  <link rel="stylesheet" href="/blog/css/style.css">
  <link rel="stylesheet" href="/blog/css/fonts.css">
  <link rel="stylesheet" href="/blog/custom.css">
  
  <link rel="icon" type="image/ico" sizes="16x16" href="/images/favicon.ico">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Stéfan&#39;s blog" />

  <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
    document.querySelectorAll("mjx-container").forEach(function(x){
      x.parentElement.classList += 'has-jax'})
  });
</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

</head>

    <body>
        <nav class="nav">
  <div class="nav-container">
    <a href="/blog/">
      <h2 class="nav-title"></h2>
    </a>
    <ul>
  <li><a href="https://mentat.za.net">mentat.za.net</a></li>
  <li><a href="/blog/">Posts</a></li>
  <li><a href="/blog/personal">Personal</a></li>
  <li><a href="/blog/follow">Follow this blog</a></li>
</ul>

  </div>
</nav>

        

<main>
	<div class="post">
		<div class="post-info">
</div>

		<h1 class="post-title">VPN-only access to the internet</h1>

<div class="post-date">
  
    January 24, 2015
  
</div>



<div class="post-tags">
  
  <div class="post-tag">
    <a href=/blog/tags/linux>
      #linux
    </a>
  </div>
  
</div>


		

		<p>A few days ago, I noticed that my outbound email wasn&rsquo;t being
delivered&mdash;it seems as if my ISP blocks access to some outbound ports.
An easy workaround is to route traffic through the work VPN, but
knowing myself I&rsquo;d forget to switch it on, leaving my outbound mail
stranded.</p>
<p>I needed a way of blocking <em>any</em> access to the internet, unless it was
leaving through the VPN (since I was sure I&rsquo;d notice <em>that</em> pretty
quickly).</p>
<p>I&rsquo;d have preferred to use firewalld, which is neatly integrated into
Ubuntu, but as of 01/24/2015 it
<a href="https://lists.fedorahosted.org/pipermail/firewalld-users/2014-October/000250.html">doesn&rsquo;t allow filtering outbound traffic</a><sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>. What
follows, then, is a simple approach implementing the following rule:</p>
<blockquote>
<p>Block wifi traffic unless it goes to either the local
network or the VPN.</p>
</blockquote>
<p>Create a script (I called it <code>~/scripts/fw-up</code>) that sets up the
firewall:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#007020">#!/bin/bash
</span><span style="color:#007020"></span>
<span style="color:#60a0b0;font-style:italic"># Clear any existing rules</span>
iptables -F

<span style="color:#60a0b0;font-style:italic"># Allow outbound DNS</span>
iptables -A OUTPUT -p udp --dport <span style="color:#40a070">53</span> -j ACCEPT
iptables -A INPUT -p udp --sport <span style="color:#40a070">53</span> -j ACCEPT

<span style="color:#60a0b0;font-style:italic"># Allow TCP access to the work VPN</span>
<span style="color:#60a0b0;font-style:italic"># Replace X.Y below with your VPN address range</span>
iptables -A OUTPUT -p tcp -d X.Y.0.0/16 -o wlan1 -j ACCEPT

<span style="color:#60a0b0;font-style:italic"># Allow any traffic destined for the vpn to go out</span>
iptables -A OUTPUT -o vpn0 -j ACCEPT

<span style="color:#60a0b0;font-style:italic"># Allow local traffic</span>
iptables -A OUTPUT -p tcp -o wlan1 -d 10.0.0.0/8 -j ACCEPT
iptables -A OUTPUT -p tcp -o wlan1 -d 172.16.0.0/12 -j ACCEPT
iptables -A OUTPUT -p tcp -o wlan1 -d 192.168.0.0/16 -j ACCEPT

<span style="color:#60a0b0;font-style:italic"># Drop everything else on the wifi</span>
iptables -A OUTPUT -p tcp -o wlan1 -j DROP
</code></pre></div><p>Make sure the script is set to executable (<code>chmod +x fw-up</code>).</p>
<p>Add a symlink to <code>if-up.d</code> to ensure that the firewall gets built
whenever the network is reconfigured:</p>
<pre><code>sudo ln -s ~/scripts/fw-up /etc/network/if-up.d/iptables
</code></pre><p>Now, whenever you connect to a wifi hotspot, internet traffic will be
blocked until you fire up your VPN.  If, on occasion, you need to work
without the VPN, simply raze the firewall:</p>
<pre><code>sudo iptables -F
</code></pre><p><strong>Update:</strong> Typically, you wouldn&rsquo;t want the firewall to go up when
connecting to the wireless at work, so I added the following conditional
in the <code>fw-up</code> script:</p>
<pre><code>iptables -F

if [[ `iwgetid -r` != 'WorkSSID' ]]; then
   # Firewall rules go here
   ...
fi
</code></pre><!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>The idea would be to set up a zone, say
<code>vpn_only</code>, and to assign your home wifi SSID to it.  A direct rule that
blocks any non-VPN traffic can then be added to the new zone (this
should be possible soon, and is on the firewalld
<a href="https://git.fedorahosted.org/cgit/firewalld.git/tree/TODO">TODO list</a>). <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>


		<script type="text/javascript">
  var disqus_identifier = "http://stefanv.github.com/blog/2015/01/24/vpn-only-internet/";
</script>



	</div>

	<div class="pagination">
		<a href="/blog/2015/01/18/docker-image-tree/" class="left arrow">&#8592;</a>
		<a href="/blog/2016/02/26/matplotlib-on-osx/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			
			<span>
			&copy; <time datetime="2021-01-14 01:49:31.630551723 -0800 PST m=&#43;0.051479333">2021</time> Stéfan van der Walt. Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
