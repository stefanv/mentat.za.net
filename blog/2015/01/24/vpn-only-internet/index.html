<!DOCTYPE html>
<html lang="en-us">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>
				VPN-only access to the internet &middot; Stéfan&#39;s blog
		</title>

		
  		<link rel="stylesheet" href="/blog/css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
		<link rel="stylesheet" href="/blog/custom.css">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Stéfan&#39;s blog" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/blog/">
					<h2 class="nav-title">Stéfan&#39;s blog</h2>
				</a>
				<ul>
    <li><a href="https://mentat.za.net">mentat.za.net</a></li>
    <li><a href="/blog/atom.xml">Atom / RSS feed</a></li>
</ul>

			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
</div>

		<h1 class="post-title">VPN-only access to the internet</h1>

<div class="post-date">
  
    January 24, 2015
  
</div>

<div class="post-tags">
  
    <div class="post-tag">
      <a href=/blog/tags/linux>
        #linux
      </a>
    </div>
  
</div>


		

		<p>A few days ago, I noticed that my outbound email wasn&rsquo;t being
delivered&mdash;it seems as if my ISP blocks access to some outbound ports.
An easy workaround is to route traffic through the work VPN, but
knowing myself I&rsquo;d forget to switch it on, leaving my outbound mail
stranded.</p>

<p>I needed a way of blocking <em>any</em> access to the internet, unless it was
leaving through the VPN (since I was sure I&rsquo;d notice <em>that</em> pretty
quickly).</p>

<p>I&rsquo;d have preferred to use firewalld, which is neatly integrated into
Ubuntu, but as of 01/24/2015 it
<a href="https://lists.fedorahosted.org/pipermail/firewalld-users/2014-October/000250.html">doesn&rsquo;t allow filtering outbound traffic</a><sup class="footnote-ref" id="fnref:firewalld-direct-zones"><a href="#fn:firewalld-direct-zones">1</a></sup>. What
follows, then, is a simple approach implementing the following rule:</p>

<blockquote>
<p>Block wifi traffic unless it goes to either the local
network or the VPN.</p>
</blockquote>

<p>Create a script (I called it <code>~/scripts/fw-up</code>) that sets up the
firewall:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#007020">#!/bin/bash
</span><span style="color:#007020"></span>
<span style="color:#60a0b0;font-style:italic"># Clear any existing rules</span>
iptables -F

<span style="color:#60a0b0;font-style:italic"># Allow outbound DNS</span>
iptables -A OUTPUT -p udp --dport <span style="color:#40a070">53</span> -j ACCEPT
iptables -A INPUT -p udp --sport <span style="color:#40a070">53</span> -j ACCEPT

<span style="color:#60a0b0;font-style:italic"># Allow TCP access to the work VPN</span>
<span style="color:#60a0b0;font-style:italic"># Replace X.Y below with your VPN address range</span>
iptables -A OUTPUT -p tcp -d X.Y.0.0/16 -o wlan1 -j ACCEPT

<span style="color:#60a0b0;font-style:italic"># Allow any traffic destined for the vpn to go out</span>
iptables -A OUTPUT -o vpn0 -j ACCEPT

<span style="color:#60a0b0;font-style:italic"># Allow local traffic</span>
iptables -A OUTPUT -p tcp -o wlan1 -d <span style="color:#40a070">10</span>.0.0.0/8 -j ACCEPT
iptables -A OUTPUT -p tcp -o wlan1 -d <span style="color:#40a070">172</span>.16.0.0/12 -j ACCEPT
iptables -A OUTPUT -p tcp -o wlan1 -d <span style="color:#40a070">192</span>.168.0.0/16 -j ACCEPT

<span style="color:#60a0b0;font-style:italic"># Drop everything else on the wifi</span>
iptables -A OUTPUT -p tcp -o wlan1 -j DROP</code></pre></div>
<p>Make sure the script is set to executable (<code>chmod +x fw-up</code>).</p>

<p>Add a symlink to <code>if-up.d</code> to ensure that the firewall gets built
whenever the network is reconfigured:</p>

<pre><code>sudo ln -s ~/scripts/fw-up /etc/network/if-up.d/iptables
</code></pre>

<p>Now, whenever you connect to a wifi hotspot, internet traffic will be
blocked until you fire up your VPN.  If, on occasion, you need to work
without the VPN, simply raze the firewall:</p>

<pre><code>sudo iptables -F
</code></pre>

<p><strong>Update:</strong> Typically, you wouldn&rsquo;t want the firewall to go up when
  connecting to the wireless at work, so I added the following conditional
  in the <code>fw-up</code> script:</p>

<pre><code>iptables -F

if [[ `iwgetid -r` != 'WorkSSID' ]]; then
   # Firewall rules go here
   ...
fi
</code></pre>

<p><code>vpn_only</code>, and to assign your home wifi SSID to it.  A direct rule that
blocks any non-VPN traffic can then be added to the new zone (this
should be possible soon, and is on the firewalld
<a href="https://git.fedorahosted.org/cgit/firewalld.git/tree/TODO">TODO list</a>).</p>

<!---
# Create a new zone

**Direct rules not supported for zones yet**



``sgs3``

```
sudo firewall-cmd --permanent --new-zone=vpn_only
sudo firewall-cmd --reload
```

In NetworkManager, go to the wifi connection and set its zone to
``vpn_only``.

(Alternatively, directly edit
``/etc/NetworkManager/system-connections/<ssid>``)


Restart NetworkManager:

```
$ sudo service network-manager restart
```

When your connection comes back up, you should see it in the new zone:

```
sudo firewall-cmd --zone=vpn_only --list-interfaces
```

Firewalld has a *direct* mode which gives us access to the inner
workings of the firewall, among other things allowing us to manipulate
outgoing and IP-based rules.

sudo firewall-cmd --zone=vpn_only --permanent --add-rich-rule='rule family="ipv4" destination address="136.152.0.0/16" invert="True" port port="1-65535" protocol="tcp" reject'

rule family="ipv4" destination NOT address="136.152.0.0/16" port
port="1-65535" protocol="tcp" reject
-->
<div class="footnotes">

<hr />

<ol>
<li id="fn:firewalld-direct-zones">The idea would be to set up a zone, say
 <a class="footnote-return" href="#fnref:firewalld-direct-zones"><sup>[return]</sup></a></li>
</ol>
</div>


		<script type="text/javascript">
  var disqus_identifier = "http://stefanv.github.com/blog/2015/01/24/vpn-only-internet/";
</script>

<div style="border-top: 0.5px solid #e5e5e5; padding-top: 1em;">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "stefanvdwalt" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

	</div>

	<div class="pagination">
		<a href="/blog/2015/01/18/docker-image-tree/" class="left arrow">&#8592;</a>
		<a href="/blog/2016/02/26/matplotlib-on-osx/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2019-08-07 00:27:21.700992227 -0700 PDT m=&#43;0.076924158">2019</time> . Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
