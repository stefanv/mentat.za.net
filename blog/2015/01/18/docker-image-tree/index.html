<!DOCTYPE html>
<html lang="en-us">
    <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Where we prune unused Docker images, and save a lot of disk space.">

  <title>Visualizing and pruning the docker image tree &middot; Stéfan&#39;s blog</title>

  
  <link rel="stylesheet" href="/blog/css/style.css">
  <link rel="stylesheet" href="/blog/css/fonts.css">
  <link rel="stylesheet" href="/blog/custom.css">
  
  <link href="" rel="alternate" type="application/rss+xml" title="Stéfan&#39;s blog" />

  <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
    document.querySelectorAll("mjx-container").forEach(function(x){
      x.parentElement.classList += 'has-jax'})
  });
</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/blog/">
					<h2 class="nav-title">Stéfan&#39;s blog</h2>
				</a>
				<ul>
    <li><a href="https://mentat.za.net">mentat.za.net</a></li>
    <li><a href="/blog/atom.xml">Atom / RSS feed</a></li>
</ul>

			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
</div>

		<h1 class="post-title">Visualizing and pruning the docker image tree</h1>

<div class="post-date">
  
    January 18, 2015
  
</div>

<div class="post-tags">
  
    <div class="post-tag">
      <a href=/blog/tags/docker>
        #docker
      </a>
    </div>
  
</div>


		

		<p>Visualizing the Docker image dependency tree is a useful way of
checking image sizes and inter-image dependencies.  Since images
occupy a lot of disk space, we may also want to prune unused images.</p>
<h2 id="visualizing-image-dependencies">Visualizing image dependencies</h2>
<p>In version 1.2.0 of Docker, the image dependency tree is available via
the <code>docker images --tree</code> command:</p>
<pre><code>$ docker images --tree
Warning: '--tree' is deprecated, it will be removed soon. See usage.
├─511136ea3c5a Virtual Size: 0 B
│ ├─5bc37dc2dfba Virtual Size: 192.5 MB
│ │ └─61cb619d86bc Virtual Size: 192.7 MB
│ │   └─3f45ca85fedc Virtual Size: 192.7 MB
│ │     └─78e82ee876a2 Virtual Size: 192.7 MB
│ │       └─dc07507cef42 Virtual Size: 192.7 MB
│ │         └─86ce37374f40 Virtual Size: 192.7 MB
│ │           └─d76983dc2ebd Virtual Size: 213.3 MB
│ │             └─04a01662a6a8 Virtual Size: 214.5 MB
│ │               └─7769c00dfefe Virtual Size: 525.9 MB
│ │                 └─6ac8d6e449b1 Virtual Size: 525.9 MB
│ │                   └─e3a84ca24205 Virtual Size: 525.9 MB
│ │                     └─26f10d07659d Virtual Size: 525.9 MB
│ ├─e12c576ad8a1 Virtual Size: 198.9 MB
│ │ └─102eb2a101b8 Virtual Size: 199.1 MB
│ │   └─530dbbae98a0 Virtual Size: 199.1 MB
│ │     └─37dde56c3a42 Virtual Size: 199.1 MB
│ │       └─8f118367086c Virtual Size: 228.5 MB
│ │         └─277eb4304907 Virtual Size: 228.5 MB Tags: ubuntu:utopic, ubuntu:14.10
...
</code></pre><p>However, the Docker team is trying to streamline its client, and has
scheduled this feature for deprecation.  How, then, do we replicate
its behavior?</p>
<p>Enter <a href="https://github.com/justone/dockviz">DockerViz</a>.  Grab a binary
from <a href="http://gobuild.io/github.com/justone/dockviz">gobuild.io</a> and
place it somewhere on your path.</p>
<h3 id="querying-the-docker-image-status">Querying the Docker image status</h3>
<p>The Docker server can be queried via its
<a href="https://docs.docker.com/reference/api/docker_remote_api/">public API</a>.
It is typically available either on <code>http://localhost:4243</code> or
<code>/var/run/docker.sock</code>.</p>
<p>One of the following two calls should therefore extract the image
status:</p>
<pre><code>curl -s http://localhost:4243/images/json?all=1
echo -e &quot;GET /images/json?all=1 HTTP/1.0\r\n&quot; | nc -U /var/run/docker.sock
</code></pre><p>On my machine, the second query returns:</p>
<pre><code>HTTP/1.0 200 OK
Content-Type: application/json
Date: Sun, 18 Jan 2015 17:41:34 GMT

[{&quot;Created&quot;:1421528518,&quot;Id&quot;:&quot;d6244a9e8b5ff885579c8c7d203e4da703e3e80621449dbbd58c365dba5c83b1&quot;,&quot;ParentId&quot;:&quot;b68521997660ae8a6916037696cf716ca415bba0766487bfa5b79cda4adfb62c&quot;,&quot;RepoTags&quot;:[&quot;datascience-base:latest&quot;],&quot;Size&quot;:0,&quot;VirtualSize&quot;:2041562468}
,{&quot;Created&quot;:1421528517,&quot;Id&quot;:&quot;b68521997660ae8a6916037696cf716ca415bba0766487bfa5b79cda4adfb62c&quot;,&quot;ParentId&quot;:&quot;d3cb571e5e16fce16a59c16c87e01ea4051d7cae016dba90688c9e4a53a921c4&quot;,&quot;RepoTags&quot;:[&quot;\u003cnone\u003e:\u003cnone\u003e&quot;],&quot;Size&quot;:0,&quot;VirtualSize&quot;:2041562468}
...
</code></pre><p>DockViz parses this JSON and outputs a formatted tree:</p>
<pre><code>$ cat ~/scripts/docktree 
echo -e &quot;GET /images/json?all=1 HTTP/1.0\r\n&quot; | nc -U /var/run/docker.sock | tail -n +5 | dockviz images --tree
$ docktree
├─511136ea3c5a Virtual Size: 0.0 B
│ ├─5bc37dc2dfba Virtual Size: 192.5 MB
│ │ └─61cb619d86bc Virtual Size: 192.7 MB
│ │   └─3f45ca85fedc Virtual Size: 192.7 MB
│ │     └─78e82ee876a2 Virtual Size: 192.7 MB
│ │       └─dc07507cef42 Virtual Size: 192.7 MB
│ │         └─86ce37374f40 Virtual Size: 192.7 MB
│ │           └─d76983dc2ebd Virtual Size: 213.3 MB
│ │             └─04a01662a6a8 Virtual Size: 214.5 MB
│ │               └─7769c00dfefe Virtual Size: 525.9 MB
│ │                 └─6ac8d6e449b1 Virtual Size: 525.9 MB
│ │                   └─e3a84ca24205 Virtual Size: 525.9 MB
│ │                     └─26f10d07659d Virtual Size: 525.9 MB
│ ├─e12c576ad8a1 Virtual Size: 198.9 MB
│ │ └─102eb2a101b8 Virtual Size: 199.1 MB
│ │   └─530dbbae98a0 Virtual Size: 199.1 MB
│ │     └─37dde56c3a42 Virtual Size: 199.1 MB
│ │       └─8f118367086c Virtual Size: 228.5 MB
│ │         └─277eb4304907 Virtual Size: 228.5 MB Tags: ubuntu:14.10, ubuntu:utopic
</code></pre><p>Note that, on my system, the first branch of the tree is dangling,
i.e. not associated with a tagged image&ndash;I must have removed a tagged
image earlier, and these are its remaining dependencies.</p>
<h2 id="pruning-unusued-images">Pruning unusued images</h2>
<p>Built and downloaded Docker images quickly gobble up a lot of space:</p>
<pre><code>$ sudo du -hcs /var/lib/docker/
10G	/var/lib/docker/
10G	total
</code></pre><p>The <code>docker images</code> command allows us to
<a href="https://docs.docker.com/reference/commandline/cli/#images">list dangling images</a>:</p>
<pre><code>docker images --filter dangling=true --quiet
</code></pre><p>And we obtain a list of containers (images that were fired up and
modified) using:</p>
<pre><code>docker ps -aq
</code></pre><p>I remove both of these with the following script (WARNING: This
will delete ALL containers and any unused, downloaded images, so use
with caution!):</p>
<pre><code>#!/bin/bash
CONTAINERS=$(docker ps -aq)
IMAGES=$(docker images --filter dangling=true --quiet)
if [[ $CONTAINERS ]]; then
    docker rm $CONTAINERS
else
    echo &quot;No containers to remove&quot;
fi

if [[ $IMAGES ]]; then
    docker rmi $IMAGES
else
    echo &quot;No dangling images to remove&quot;
fi
</code></pre><p>Then:</p>
<pre><code>$ docker-clean
$ sudo du -hcs /var/lib/docker/
6.6G	/var/lib/docker/
6.6G	total
$ docktree
└─511136ea3c5a Virtual Size: 0.0 B
  ├─e12c576ad8a1 Virtual Size: 198.9 MB
  │ └─102eb2a101b8 Virtual Size: 199.1 MB
  │   └─530dbbae98a0 Virtual Size: 199.1 MB
  │     └─37dde56c3a42 Virtual Size: 199.1 MB
  │       └─8f118367086c Virtual Size: 228.5 MB
  │         └─277eb4304907 Virtual Size: 228.5 MB Tags: ubuntu:utopic, ubuntu:14.10
  ├─d497ad3926c8 Virtual Size: 192.5 MB
  │ └─ccb62158e970 Virtual Size: 192.7 MB
  │   └─e791be0477f2 Virtual Size: 192.7 MB
...
</code></pre><p>Note that, now, all branches of the tree are associated with tagged
images.  If I remove <code>ubuntu:utopic</code>, I can again run the pruning
process to get rid of its left-over dependencies.</p>


		<script type="text/javascript">
  var disqus_identifier = "http://stefanv.github.com/blog/2015/01/18/docker-image-tree/";
</script>

<div style="border-top: 0.5px solid #e5e5e5; padding-top: 1em;">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "stefanvdwalt" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

	</div>

	<div class="pagination">
		<a href="/blog/2013/06/27/scipy2013-proceedings/" class="left arrow">&#8592;</a>
		<a href="/blog/2015/01/24/vpn-only-internet/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2020-08-26 22:59:30.148673609 -0700 PDT m=&#43;0.056598481">2020</time> . Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
