<!DOCTYPE html>
<html lang="en-us">
    <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Where we store links to emails in org-mode, and open them using neomutt.">

  <title>Linking to emails in org-mode (using neomutt) &middot; Stéfan&#39;s blog</title>

  
  <link rel="stylesheet" href="/blog/css/style.css">
  <link rel="stylesheet" href="/blog/css/fonts.css">
  <link rel="stylesheet" href="/blog/custom.css">
  
  <link rel="icon" type="image/ico" sizes="16x16" href="/images/favicon.ico">

  
  
  <link href="https://mentat.za.net/blog/posts/atom.xml" rel="alternate" type="application/atom+xml" title="Stéfan&#39;s blog" />

  <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
    document.querySelectorAll("mjx-container").forEach(function(x){
      x.parentElement.classList += 'has-jax'})
  });
</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

</head>

    <body>
        <nav class="nav">
  <div class="nav-container">
    <a href="/blog/">
      <h2 class="nav-title"></h2>
    </a>
    <ul>
  <li><a href="https://mentat.za.net">mentat.za.net</a></li>
  <li><a href="/blog/">Posts</a></li>
  <li><a href="/blog/personal">Personal</a></li>
  <li><a href="/blog/follow">Follow this blog</a></li>
</ul>

  </div>
</nav>

        

<main>
	<div class="post">
		<div class="post-info">
</div>

		<h1 class="post-title">Linking to emails in org-mode (using neomutt)</h1>

<div class="post-date">
  
    October 31, 2018
  
</div>



<div class="post-tags">
  
    <div class="post-tag">
      <a href=/blog/tags/org-mode>
        #org-mode
      </a>
    </div>
  
    <div class="post-tag">
      <a href=/blog/tags/emacs>
        #emacs
      </a>
    </div>
  
    <div class="post-tag">
      <a href=/blog/tags/python>
        #python
      </a>
    </div>
  
    <div class="post-tag">
      <a href=/blog/tags/mutt>
        #mutt
      </a>
    </div>
  
</div>


		

		<p><em><strong>Update 2018-11-2:</strong> Change the URL scheme to <code>message://</code>.
See <a href="#other-systems">&ldquo;Other Systems&rdquo;</a> below.</em></p>
<p><a href="https://orgmode.org">org-mode</a> is, to me, is one of the most valuable
parts of the emacs ecosystem.  I use it to take notes, plan projects,
manage tasks, and write &amp; publish documents.</p>
<p>Nowadays, a lot of work arrives via email, and so it is helpful to be
able to refer to messages directly from my notes or lists of
tasks.</p>
<p>The <em>simplest</em> option might be to store URLs pointing to an online
inbox such as <a href="https://fastmail.com">Fastmail</a> or GMail, but I wanted
a solution that was both future proof (i.e., what if I moved my emails
to a different provider?) and worked with my terminal-based mail
client of choice, <a href="https://neomutt.org/">neomutt</a>.</p>
<p>I started with
a
<a href="https://upsilon.cc/~zack/blog/posts/2010/02/integrating_Mutt_with_Org-mode/">solution provided by Stefano Zacchiroli</a>,
and simplified it for my specific use-case.</p>
<h2 id="overview">Overview</h2>
<p>The solution has two parts: sending email links from neomutt to Emacs,
and later opening those links from Emacs by invoking neomutt.  The
first achieved via <code>org-protocol</code>, the latter via launching neomutt
and then simulating keypresses.</p>
<p>When launching neomutt, we have to tell it in which directory the
message lives.  We therefore use <code>notmuch</code> to find the message file
first, based on its Message-ID.  <code>maildir-utils</code> would be another way
of doing so.  <strong>Please note that you have to have notmuch or
maildir-utils set up already for this scheme to work.</strong></p>
<p>I initially avoided the <code>org-protocol</code> package, because installation
looked complicated.  That, it turns out, is only the case if you care
about web browser integration, which we don&rsquo;t.</p>
<h2 id="neomutt-configuration">Neomutt configuration</h2>
<p>First, we have a Python script that can parse an e-mail and share the
Message-ID and Subject with emacs.  I call it <code>mutt-save-org-link.py</code>,
and make it executable using <code>chmod +x mutt-save-org-link.py</code>.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#60a0b0;font-style:italic">#!/usr/bin/env python3</span>

<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">sys</span>
<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">email</span>
<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">subprocess</span>
<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">urllib.parse</span>

<span style="color:#60a0b0;font-style:italic"># Parse the email from standard input</span>
message_bytes <span style="color:#666">=</span> sys<span style="color:#666">.</span>stdin<span style="color:#666">.</span>buffer<span style="color:#666">.</span>read()
message <span style="color:#666">=</span> email<span style="color:#666">.</span>message_from_bytes(message_bytes)

<span style="color:#60a0b0;font-style:italic"># Grab the relevant message headers</span>
message_id <span style="color:#666">=</span> urllib<span style="color:#666">.</span>parse<span style="color:#666">.</span>quote(message[<span style="color:#4070a0">&#39;message-id&#39;</span>][<span style="color:#40a070">1</span>:<span style="color:#666">-</span><span style="color:#40a070">1</span>])
subject <span style="color:#666">=</span> message[<span style="color:#4070a0">&#39;subject&#39;</span>]

<span style="color:#60a0b0;font-style:italic"># Ask emacsclient to save a link to the message</span>
subprocess<span style="color:#666">.</span>Popen([
    <span style="color:#4070a0">&#39;emacsclient&#39;</span>,
    f<span style="color:#4070a0">&#39;org-protocol://store-link?url=message://{message_id}&amp;title={subject}&#39;</span>
])
</code></pre></div><p>We then configure neomutt (typically in <code>~/.muttrc</code>) to call the
script with a shortcut.  I chose Esc-L (the same as Alt-L).</p>
<pre><code>macro index,pager \el &quot;|~/scripts/mutt-save-org-link.py\n&quot;
</code></pre><h2 id="emacs-configuration">Emacs configuration</h2>
<p>Using <code>org-protocol</code>, we instruct emacsclient to intercept URLs with
the <code>org-protocol://</code> scheme, as used by our <code>mutt-save-org-link.py</code>
script.  We also tell org-mode how to handle special URLs of the form
<code>message://message-id+goes_here@mail.gmail.com</code>.  Neomutt needs to know
which Maildir folder to open, so we ask <code>notmuch</code> to tell us where the
message is located.</p>
<p>In my <code>~/.emacs</code> file I have:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-elisp" data-lang="elisp"><span style="color:#60a0b0;font-style:italic">; Make sure org-protocol is loaded</span>
<span style="color:#60a0b0;font-style:italic">; Now, org-protocol:// schemas are intercepted.</span>
(<span style="color:#007020">require</span> <span style="color:#bb60d5">org-protocol</span>)

<span style="color:#60a0b0;font-style:italic">; Call this function, which spawns neomutt, whenever org-mode</span>
<span style="color:#60a0b0;font-style:italic">; tries to open a link of the form message://message-id+goes_here@mail.gmail.com</span>
(<span style="color:#007020">defun</span> <span style="color:#bb60d5">stefanv/mutt-open-message</span> (<span style="color:#bb60d5">message-id</span>)
  <span style="color:#4070a0">&#34;In neomutt, open the email with the the given Message-ID&#34;</span>
  (<span style="color:#007020">let*</span>
      ((<span style="color:#bb60d5">message-id</span> (<span style="color:#bb60d5">replace-regexp-in-string</span> <span style="color:#4070a0">&#34;^/*&#34;</span> <span style="color:#4070a0">&#34;&#34;</span> <span style="color:#bb60d5">message-id</span>))
       (<span style="color:#bb60d5">mail-file</span>
        (<span style="color:#bb60d5">replace-regexp-in-string</span>
         <span style="color:#4070a0">&#34;\n$&#34;</span> <span style="color:#4070a0">&#34;&#34;</span> (<span style="color:#bb60d5">shell-command-to-string</span>
                   (<span style="color:#06287e">format</span> <span style="color:#4070a0">&#34;notmuch search --output=files id:%s&#34;</span> <span style="color:#bb60d5">message-id</span>))))
       (<span style="color:#bb60d5">mail-dir</span> (<span style="color:#bb60d5">replace-regexp-in-string</span> <span style="color:#4070a0">&#34;/\\(cur\\|new\\|tmp\\)/$&#34;</span> <span style="color:#4070a0">&#34;&#34;</span>
                                           (<span style="color:#06287e">file-name-directory</span> <span style="color:#bb60d5">mail-file</span>)))
       (<span style="color:#06287e">process-id</span> (<span style="color:#06287e">concat</span> <span style="color:#4070a0">&#34;neomutt-&#34;</span> <span style="color:#bb60d5">message-id</span>))
       (<span style="color:#bb60d5">message-id-escaped</span> (<span style="color:#06287e">regexp-quote</span> <span style="color:#bb60d5">message-id</span>))
       (<span style="color:#bb60d5">mutt-keystrokes</span>
        (<span style="color:#06287e">format</span> <span style="color:#4070a0">&#34;l~i %s\n\n&#34;</span> (<span style="color:#bb60d5">shell-quote-argument</span> <span style="color:#bb60d5">message-id-escaped</span>)))
       (<span style="color:#bb60d5">mutt-command</span> (<span style="color:#06287e">list</span> <span style="color:#4070a0">&#34;neomutt&#34;</span> <span style="color:#4070a0">&#34;-R&#34;</span> <span style="color:#4070a0">&#34;-f&#34;</span> <span style="color:#bb60d5">mail-dir</span>
                           <span style="color:#4070a0">&#34;-e&#34;</span> (<span style="color:#06287e">format</span> <span style="color:#4070a0">&#34;push &#39;%s&#39;&#34;</span> <span style="color:#bb60d5">mutt-keystrokes</span>))))

    (<span style="color:#06287e">message</span> <span style="color:#4070a0">&#34;Launching neomutt for message %s&#34;</span> <span style="color:#bb60d5">message-id</span>)
    (<span style="color:#06287e">call-process</span> <span style="color:#4070a0">&#34;setsid&#34;</span> <span style="color:#60add5">nil</span> <span style="color:#60add5">nil</span>
                   <span style="color:#4070a0">&#34;-f&#34;</span> <span style="color:#4070a0">&#34;gnome-terminal&#34;</span> <span style="color:#4070a0">&#34;--window&#34;</span> <span style="color:#4070a0">&#34;--&#34;</span>
                   <span style="color:#4070a0">&#34;neomutt&#34;</span> <span style="color:#4070a0">&#34;-R&#34;</span> <span style="color:#4070a0">&#34;-f&#34;</span> <span style="color:#bb60d5">mail-dir</span>
                   <span style="color:#4070a0">&#34;-e&#34;</span> (<span style="color:#06287e">format</span> <span style="color:#4070a0">&#34;push &#39;%s&#39;&#34;</span> <span style="color:#bb60d5">mutt-keystrokes</span>))))

<span style="color:#60a0b0;font-style:italic">; Whenever org-mode sees a link starting with `message://`, it</span>
<span style="color:#60a0b0;font-style:italic">; calls our `mutt-open-message` function</span>
(<span style="color:#bb60d5">org-add-link-type</span> <span style="color:#4070a0">&#34;message&#34;</span> <span style="color:#517918">&#39;stefanv/mutt-open-message</span>)
</code></pre></div><p>There are a few caveats: if you use <code>maildir-utils</code>, the search
command is <code>mu find -f l i:%s</code> instead of notmuch; and if you are not
on Linux, then <code>setsid</code> (which we use to launch a detached background
process) is not going to work, and you will want to use a different
terminal emulator.</p>
<h2 id="a-nameother-systemsaother-systems"><!-- raw HTML omitted --><!-- raw HTML omitted -->Other Systems</h2>
<p><a href="https://vxlabs.com/">Charl Botha</a> mentioned in the comments that, on
MacOS,
<a href="https://orgmode.org/worg/org-contrib/org-mac-link.html">org-mac-link</a>
lets you grab hyperlinks from a wide variety of apps.  Email messages,
specifically, are stored as <code>message://message-id</code> URLs, which MacOS
knows how to open.  This post has been updated to use the same link schema.</p>
<h2 id="wrap-up">Wrap-up</h2>
<p>That&rsquo;s it!  I&rsquo;ve added the code
to
<a href="https://github.com/stefanv/org-neomutt">https://github.com/stefanv/org-neomutt</a>.
Please file issues and PRs there, or tell me about your use cases
in the comments below.</p>


		<script type="text/javascript">
  var disqus_identifier = "http://stefanv.github.com/blog/2018/10/31/using-org-mode-with-neomutt/";
</script>



	</div>

	<div class="pagination">
		<a href="/blog/2016/12/15/org-mode-header-search/" class="left arrow">&#8592;</a>
		<a href="/blog/2019/07/05/intelligent-augmentation/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			
			<span>
			&copy; <time datetime="2021-01-14 12:15:34.885657323 -0800 PST m=&#43;0.124659467">2021</time> Stéfan van der Walt. Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
