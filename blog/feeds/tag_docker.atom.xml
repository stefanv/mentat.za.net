<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Stéfan van der Walt - docker</title><link href="https://mentat.za.net/blog/" rel="alternate"></link><link href="https://mentat.za.net/blog/feeds/tag_docker.atom.xml" rel="self"></link><id>https://mentat.za.net/blog/</id><updated>2015-01-18T00:00:00-08:00</updated><entry><title>Visualizing and pruning the docker image tree</title><link href="https://mentat.za.net/blog/2015/01/18/docker-image-tree/" rel="alternate"></link><published>2015-01-18T00:00:00-08:00</published><updated>2015-01-18T00:00:00-08:00</updated><author><name>Stefan van der Walt</name></author><id>tag:mentat.za.net,2015-01-18:/blog/2015/01/18/docker-image-tree/</id><summary type="html">&lt;p&gt;Where we prune unused Docker images, and save a lot of disk space.&lt;/p&gt;</summary><content type="html">&lt;p&gt;Visualizing the Docker image dependency tree is a useful way of
checking image sizes and inter-image dependencies.  Since images
occupy a lot of disk space, we may also want to prune unused images.&lt;/p&gt;
&lt;h2 id="visualizing-image-dependencies"&gt;Visualizing image dependencies&lt;/h2&gt;
&lt;p&gt;In version 1.2.0 of Docker, the image dependency tree is available via
the &lt;code&gt;docker images --tree&lt;/code&gt; command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ docker images --tree
Warning: &lt;span class="s1"&gt;&amp;#39;--tree&amp;#39;&lt;/span&gt; is deprecated, it will be removed soon. See usage.
├─511136ea3c5a Virtual Size: &lt;span class="m"&gt;0&lt;/span&gt; B
│ ├─5bc37dc2dfba Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.5 MB
│ │ └─61cb619d86bc Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.7 MB
│ │   └─3f45ca85fedc Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.7 MB
│ │     └─78e82ee876a2 Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.7 MB
│ │       └─dc07507cef42 Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.7 MB
│ │         └─86ce37374f40 Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.7 MB
│ │           └─d76983dc2ebd Virtual Size: &lt;span class="m"&gt;213&lt;/span&gt;.3 MB
│ │             └─04a01662a6a8 Virtual Size: &lt;span class="m"&gt;214&lt;/span&gt;.5 MB
│ │               └─7769c00dfefe Virtual Size: &lt;span class="m"&gt;525&lt;/span&gt;.9 MB
│ │                 └─6ac8d6e449b1 Virtual Size: &lt;span class="m"&gt;525&lt;/span&gt;.9 MB
│ │                   └─e3a84ca24205 Virtual Size: &lt;span class="m"&gt;525&lt;/span&gt;.9 MB
│ │                     └─26f10d07659d Virtual Size: &lt;span class="m"&gt;525&lt;/span&gt;.9 MB
│ ├─e12c576ad8a1 Virtual Size: &lt;span class="m"&gt;198&lt;/span&gt;.9 MB
│ │ └─102eb2a101b8 Virtual Size: &lt;span class="m"&gt;199&lt;/span&gt;.1 MB
│ │   └─530dbbae98a0 Virtual Size: &lt;span class="m"&gt;199&lt;/span&gt;.1 MB
│ │     └─37dde56c3a42 Virtual Size: &lt;span class="m"&gt;199&lt;/span&gt;.1 MB
│ │       └─8f118367086c Virtual Size: &lt;span class="m"&gt;228&lt;/span&gt;.5 MB
│ │         └─277eb4304907 Virtual Size: &lt;span class="m"&gt;228&lt;/span&gt;.5 MB Tags: ubuntu:utopic, ubuntu:14.10
...
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;However, the Docker team is trying to streamline its client, and has
scheduled this feature for deprecation.  How, then, do we replicate
its behavior?&lt;/p&gt;
&lt;p&gt;Enter &lt;a href="https://github.com/justone/dockviz"&gt;DockerViz&lt;/a&gt;.  Grab a binary
from &lt;a href="http://gobuild.io/github.com/justone/dockviz"&gt;gobuild.io&lt;/a&gt; and
place it somewhere on your path.&lt;/p&gt;
&lt;h3 id="querying-the-docker-image-status"&gt;Querying the Docker image status&lt;/h3&gt;
&lt;p&gt;The Docker server can be queried via its
&lt;a href="https://docs.docker.com/reference/api/docker_remote_api/"&gt;public API&lt;/a&gt;.
It is typically available either on &lt;code&gt;http://localhost:4243&lt;/code&gt; or
&lt;code&gt;/var/run/docker.sock&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;One of the following two calls should therefore extract the image
status:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;curl&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="n"&gt;http&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;localhost&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;4243&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;images&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;&lt;span class="k"&gt;all&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt; &lt;span class="ss"&gt;&amp;quot;GET /images/json?all=1 HTTP/1.0\r\n&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;nc&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;U&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;var&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;run&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;docker&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sock&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;On my machine, the second query returns:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;HTTP&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;200&lt;/span&gt; &lt;span class="n"&gt;OK&lt;/span&gt;
&lt;span class="n"&gt;Content&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;Type&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;application&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;
&lt;span class="nb"&gt;Date&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Sun&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;18&lt;/span&gt; &lt;span class="n"&gt;Jan&lt;/span&gt; &lt;span class="mi"&gt;2015&lt;/span&gt; &lt;span class="mi"&gt;17&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;41&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;34&lt;/span&gt; &lt;span class="n"&gt;GMT&lt;/span&gt;

&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;Created&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1421528518&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;Id&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;d6244a9e8b5ff885579c8c7d203e4da703e3e80621449dbbd58c365dba5c83b1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;ParentId&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;b68521997660ae8a6916037696cf716ca415bba0766487bfa5b79cda4adfb62c&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;RepoTags&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:[&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;datascience-base:latest&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;Size&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;VirtualSize&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2041562468&lt;/span&gt;&lt;span class="err"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;Created&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1421528517&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;Id&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;b68521997660ae8a6916037696cf716ca415bba0766487bfa5b79cda4adfb62c&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;ParentId&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;d3cb571e5e16fce16a59c16c87e01ea4051d7cae016dba90688c9e4a53a921c4&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;RepoTags&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:[&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;\u003cnone\u003e:\u003cnone\u003e&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;Size&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;VirtualSize&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2041562468&lt;/span&gt;&lt;span class="err"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;DockViz parses this JSON and outputs a formatted tree:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ cat ~/scripts/docktree 
&lt;span class="nb"&gt;echo&lt;/span&gt; -e &lt;span class="s2"&gt;&amp;quot;GET /images/json?all=1 HTTP/1.0\r\n&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; nc -U /var/run/docker.sock &lt;span class="p"&gt;|&lt;/span&gt; tail -n +5 &lt;span class="p"&gt;|&lt;/span&gt; dockviz images --tree
$ docktree
├─511136ea3c5a Virtual Size: &lt;span class="m"&gt;0&lt;/span&gt;.0 B
│ ├─5bc37dc2dfba Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.5 MB
│ │ └─61cb619d86bc Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.7 MB
│ │   └─3f45ca85fedc Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.7 MB
│ │     └─78e82ee876a2 Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.7 MB
│ │       └─dc07507cef42 Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.7 MB
│ │         └─86ce37374f40 Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.7 MB
│ │           └─d76983dc2ebd Virtual Size: &lt;span class="m"&gt;213&lt;/span&gt;.3 MB
│ │             └─04a01662a6a8 Virtual Size: &lt;span class="m"&gt;214&lt;/span&gt;.5 MB
│ │               └─7769c00dfefe Virtual Size: &lt;span class="m"&gt;525&lt;/span&gt;.9 MB
│ │                 └─6ac8d6e449b1 Virtual Size: &lt;span class="m"&gt;525&lt;/span&gt;.9 MB
│ │                   └─e3a84ca24205 Virtual Size: &lt;span class="m"&gt;525&lt;/span&gt;.9 MB
│ │                     └─26f10d07659d Virtual Size: &lt;span class="m"&gt;525&lt;/span&gt;.9 MB
│ ├─e12c576ad8a1 Virtual Size: &lt;span class="m"&gt;198&lt;/span&gt;.9 MB
│ │ └─102eb2a101b8 Virtual Size: &lt;span class="m"&gt;199&lt;/span&gt;.1 MB
│ │   └─530dbbae98a0 Virtual Size: &lt;span class="m"&gt;199&lt;/span&gt;.1 MB
│ │     └─37dde56c3a42 Virtual Size: &lt;span class="m"&gt;199&lt;/span&gt;.1 MB
│ │       └─8f118367086c Virtual Size: &lt;span class="m"&gt;228&lt;/span&gt;.5 MB
│ │         └─277eb4304907 Virtual Size: &lt;span class="m"&gt;228&lt;/span&gt;.5 MB Tags: ubuntu:14.10, ubuntu:utopic
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Note that, on my system, the first branch of the tree is dangling,
i.e. not associated with a tagged image&amp;ndash;I must have removed a tagged
image earlier, and these are its remaining dependencies.&lt;/p&gt;
&lt;h2 id="pruning-unusued-images"&gt;Pruning unusued images&lt;/h2&gt;
&lt;p&gt;Built and downloaded Docker images quickly gobble up a lot of space:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ sudo du -hcs /var/lib/docker/
10G /var/lib/docker/
10G total
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The &lt;code&gt;docker images&lt;/code&gt; command allows us to
&lt;a href="https://docs.docker.com/reference/commandline/cli/#images"&gt;list dangling images&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;docker&lt;/span&gt; &lt;span class="n"&gt;images&lt;/span&gt; &lt;span class="c1"&gt;--filter dangling=true --quiet&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And we obtain a list of containers (images that were fired up and
modified) using:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;docker&lt;/span&gt; &lt;span class="n"&gt;ps&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;aq&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;I remove both of these with the following script (WARNING: This
will delete ALL containers and any unused, downloaded images, so use
with caution!):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;
&lt;span class="nv"&gt;CONTAINERS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;docker ps -aq&lt;span class="k"&gt;)&lt;/span&gt;
&lt;span class="nv"&gt;IMAGES&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;docker images --filter &lt;span class="nv"&gt;dangling&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;true&lt;/span&gt; --quiet&lt;span class="k"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[[&lt;/span&gt; &lt;span class="nv"&gt;$CONTAINERS&lt;/span&gt; &lt;span class="o"&gt;]]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;then&lt;/span&gt;
    docker rm &lt;span class="nv"&gt;$CONTAINERS&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;
    &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;No containers to remove&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[[&lt;/span&gt; &lt;span class="nv"&gt;$IMAGES&lt;/span&gt; &lt;span class="o"&gt;]]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;then&lt;/span&gt;
    docker rmi &lt;span class="nv"&gt;$IMAGES&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;
    &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;No dangling images to remove&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ docker-clean
$ sudo du -hcs /var/lib/docker/
&lt;span class="m"&gt;6&lt;/span&gt;.6G    /var/lib/docker/
&lt;span class="m"&gt;6&lt;/span&gt;.6G    total
$ docktree
└─511136ea3c5a Virtual Size: &lt;span class="m"&gt;0&lt;/span&gt;.0 B
  ├─e12c576ad8a1 Virtual Size: &lt;span class="m"&gt;198&lt;/span&gt;.9 MB
  │ └─102eb2a101b8 Virtual Size: &lt;span class="m"&gt;199&lt;/span&gt;.1 MB
  │   └─530dbbae98a0 Virtual Size: &lt;span class="m"&gt;199&lt;/span&gt;.1 MB
  │     └─37dde56c3a42 Virtual Size: &lt;span class="m"&gt;199&lt;/span&gt;.1 MB
  │       └─8f118367086c Virtual Size: &lt;span class="m"&gt;228&lt;/span&gt;.5 MB
  │         └─277eb4304907 Virtual Size: &lt;span class="m"&gt;228&lt;/span&gt;.5 MB Tags: ubuntu:utopic, ubuntu:14.10
  ├─d497ad3926c8 Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.5 MB
  │ └─ccb62158e970 Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.7 MB
  │   └─e791be0477f2 Virtual Size: &lt;span class="m"&gt;192&lt;/span&gt;.7 MB
...
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Note that, now, all branches of the tree are associated with tagged
images.  If I remove &lt;code&gt;ubuntu:utopic&lt;/code&gt;, I can again run the pruning
process to get rid of its left-over dependencies.&lt;/p&gt;</content><category term="docker"></category></entry></feed>