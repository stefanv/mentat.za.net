<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Stéfan van der Walt - linux</title><link href="http://mentat.za.net/blog/" rel="alternate"></link><link href="http://mentat.za.net/blog/feeds/tag_linux.atom.xml" rel="self"></link><id>http://mentat.za.net/blog/</id><updated>2015-01-24T00:00:00-08:00</updated><entry><title>VPN-only access to the internet</title><link href="http://mentat.za.net/blog/2015/01/24/vpn-only-internet/" rel="alternate"></link><published>2015-01-24T00:00:00-08:00</published><updated>2015-01-24T00:00:00-08:00</updated><author><name>Stefan van der Walt</name></author><id>tag:mentat.za.net,2015-01-24:/blog/2015/01/24/vpn-only-internet/</id><summary type="html">&lt;p&gt;tl;dr A firewall setup that allows traffic to leave &lt;em&gt;only&lt;/em&gt; via the VPN&lt;/p&gt;
&lt;p&gt;A few days ago, I noticed that my outbound email wasn't being
delivered---it seems as if my ISP blocks access to some outbound ports.
An easy workaround is to route traffic through the work VPN, but …&lt;/p&gt;</summary><content type="html">&lt;p&gt;tl;dr A firewall setup that allows traffic to leave &lt;em&gt;only&lt;/em&gt; via the VPN&lt;/p&gt;
&lt;p&gt;A few days ago, I noticed that my outbound email wasn't being
delivered---it seems as if my ISP blocks access to some outbound ports.
An easy workaround is to route traffic through the work VPN, but
knowing myself I'd forget to switch it on, leaving my outbound mail
stranded.&lt;/p&gt;
&lt;p&gt;I needed a way of blocking &lt;em&gt;any&lt;/em&gt; access to the internet, unless it was
leaving through the VPN (since I was sure I'd notice &lt;em&gt;that&lt;/em&gt; pretty
quickly).&lt;/p&gt;
&lt;p&gt;I'd have preferred to use firewalld, which is neatly integrated into
Ubuntu, but as of 01/24/2015 it 
&lt;a href="https://lists.fedorahosted.org/pipermail/firewalld-users/2014-October/000250.html"&gt;doesn't allow filtering outbound traffic&lt;/a&gt;[^firewalld_direct_zones]. What
follows, then, is a simple approach implementing the following rule:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Block wifi traffic unless it goes to either the local
network or the VPN.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Create a script (I called it &lt;code&gt;~/scripts/fw-up&lt;/code&gt;) that sets up the
firewall:&lt;/p&gt;
&lt;p&gt;```bash&lt;/p&gt;
&lt;h1&gt;!/bin/bash&lt;/h1&gt;
&lt;h1&gt;Clear any existing rules&lt;/h1&gt;
&lt;p&gt;iptables -F&lt;/p&gt;
&lt;h1&gt;Allow outbound DNS&lt;/h1&gt;
&lt;p&gt;iptables -A OUTPUT -p udp --dport 53 -j ACCEPT
iptables -A INPUT -p udp --sport 53 -j ACCEPT&lt;/p&gt;
&lt;h1&gt;Allow TCP access to the work VPN&lt;/h1&gt;
&lt;h1&gt;Replace X.Y below with your VPN address range&lt;/h1&gt;
&lt;p&gt;iptables -A OUTPUT -p tcp -d X.Y.0.0/16 -o wlan1 -j ACCEPT&lt;/p&gt;
&lt;h1&gt;Allow any traffic destined for the vpn to go out&lt;/h1&gt;
&lt;p&gt;iptables -A OUTPUT -o vpn0 -j ACCEPT&lt;/p&gt;
&lt;h1&gt;Allow local traffic&lt;/h1&gt;
&lt;p&gt;iptables -A OUTPUT -p tcp -o wlan1 -d 10.0.0.0/8 -j ACCEPT
iptables -A OUTPUT -p tcp -o wlan1 -d 172.16.0.0/12 -j ACCEPT
iptables -A OUTPUT -p tcp -o wlan1 -d 192.168.0.0/16 -j ACCEPT&lt;/p&gt;
&lt;h1&gt;Drop everything else on the wifi&lt;/h1&gt;
&lt;p&gt;iptables -A OUTPUT -p tcp -o wlan1 -j DROP
```&lt;/p&gt;
&lt;p&gt;Make sure the script is set to executable (&lt;code&gt;chmod +x fw-up&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;Add a symlink to &lt;code&gt;if-up.d&lt;/code&gt; to ensure that the firewall gets built
whenever the network is reconfigured:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;sudo ln -s ~/scripts/fw-up /etc/network/if-up.d/iptables&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Now, whenever you connect to a wifi hotspot, internet traffic will be
blocked until you fire up your VPN.  If, on occasion, you need to work
without the VPN, simply raze the firewall:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;sudo iptables -F&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Update:&lt;/strong&gt; Typically, you wouldn't want the firewall to go up when
  connecting to the wireless at work, so I added the following conditional
  in the &lt;code&gt;fw-up&lt;/code&gt; script:&lt;/p&gt;
&lt;p&gt;```
iptables -F&lt;/p&gt;
&lt;p&gt;if [[ &lt;code&gt;iwgetid -r&lt;/code&gt; != 'WorkSSID' ]]; then
   # Firewall rules go here
   ...
fi
```&lt;/p&gt;
&lt;p&gt;[^firewalld_direct_zones]: The idea would be to set up a zone, say
&lt;code&gt;vpn_only&lt;/code&gt;, and to assign your home wifi SSID to it.  A direct rule that
blocks any non-VPN traffic can then be added to the new zone (this
should be possible soon, and is on the firewalld
&lt;a href="https://git.fedorahosted.org/cgit/firewalld.git/tree/TODO"&gt;TODO list&lt;/a&gt;).&lt;/p&gt;
&lt;!---
# Create a new zone

**Direct rules not supported for zones yet**



``sgs3``

```
sudo firewall-cmd --permanent --new-zone=vpn_only
sudo firewall-cmd --reload
```

In NetworkManager, go to the wifi connection and set its zone to
``vpn_only``.

(Alternatively, directly edit
``/etc/NetworkManager/system-connections/&lt;ssid&gt;``)


Restart NetworkManager:

```
$ sudo service network-manager restart
```

When your connection comes back up, you should see it in the new zone:

```
sudo firewall-cmd --zone=vpn_only --list-interfaces
```

Firewalld has a *direct* mode which gives us access to the inner
workings of the firewall, among other things allowing us to manipulate
outgoing and IP-based rules.

sudo firewall-cmd --zone=vpn_only --permanent --add-rich-rule='rule family="ipv4" destination address="136.152.0.0/16" invert="True" port port="1-65535" protocol="tcp" reject'

rule family="ipv4" destination NOT address="136.152.0.0/16" port
port="1-65535" protocol="tcp" reject
--&gt;</content><category term="linux"></category></entry><entry><title>Adobe's new free font: Source Code Pro</title><link href="http://mentat.za.net/blog/2012/09/26/consolas-vs-source-code-pro/" rel="alternate"></link><published>2012-09-26T11:49:00-07:00</published><updated>2012-09-26T11:49:00-07:00</updated><author><name>Stefan van der Walt</name></author><id>tag:mentat.za.net,2012-09-26:/blog/2012/09/26/consolas-vs-source-code-pro/</id><summary type="html">&lt;p&gt;Adobe yesterday
&lt;a href="http://blogs.adobe.com/typblography/2012/09/source-code-pro.html"&gt;released its free and open source Type family, Source Code Pro&lt;/a&gt;,
which includes an eye-pleasing monospace font  ideally suited for coding.
In the past, and at the recommendation of &lt;a href="http://blog.fperez.org/"&gt;Fernando Perez&lt;/a&gt;, I've
used the beautiful (but non-free) &lt;a href="http://www.microsoft.com/en-us/download/details.aspx?id=17879"&gt;Consolas by Microsoft&lt;/a&gt;; now,
which is best?&lt;/p&gt;
&lt;p&gt;To install on Linux …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Adobe yesterday
&lt;a href="http://blogs.adobe.com/typblography/2012/09/source-code-pro.html"&gt;released its free and open source Type family, Source Code Pro&lt;/a&gt;,
which includes an eye-pleasing monospace font  ideally suited for coding.
In the past, and at the recommendation of &lt;a href="http://blog.fperez.org/"&gt;Fernando Perez&lt;/a&gt;, I've
used the beautiful (but non-free) &lt;a href="http://www.microsoft.com/en-us/download/details.aspx?id=17879"&gt;Consolas by Microsoft&lt;/a&gt;; now,
which is best?&lt;/p&gt;
&lt;p&gt;To install on Linux:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href="https://github.com/adobe-fonts/source-code-pro/releases/tag/variable-fonts"&gt;Grab the font&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;Copy the files to &lt;code&gt;~/.fonts&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Run &lt;code&gt;fc-cache -f -v&lt;/code&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The font should now be available for selection in apps such as Firefox, Gnome
Terminal, etc.  To make it the default font in Emacs::&lt;/p&gt;
&lt;p&gt;&lt;code&gt;common-lisp
    (set-default-font "Source Code Pro")&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Here's a comparison of Consolas (left) and Source Code Pro (right):&lt;/p&gt;
&lt;p&gt;&lt;img src="/blog/images/consolas_vs_source_code_pro.png"&gt;&lt;/p&gt;
&lt;p&gt;Comments also on &lt;a href="https://plus.google.com/104831275312843762750/posts/Ju6Ns8Dtuik"&gt;Google+&lt;/a&gt;.&lt;/p&gt;</content><category term="coding"></category><category term="emacs"></category><category term="linux"></category></entry></feed>